# 개발 환경에서도 디스크 폭증이 일어난 이유와 해결 방법

## 📌 주제: 관측 도구의 운영 오버헤드와 저장 공간 관리

오늘은 개발 환경에서 **디스크 용량이 급격히 폭증**했던 문제를 분석하고,  
그 원인과 해결 방법을 정리해봤다.

---

## 💥 발생한 문제

- 개발 중인 환경에서 Docker가 갑자기 멈추고 시스템 경고 발생
- 확인 결과 `Docker.raw` 파일이 수백 GB에 달했고, Prometheus, Elasticsearch도 마찬가지로 저장 공간을 과도하게 사용
- 서비스, 모니터링, 로그 시스템 전체에서 오류가 잇따라 발생

---

## 🔍 원인 분석

### 1. **초기 디폴트 설정이 너무 관대했다**
- Prometheus는 기본 보관 기간이 15일 이상이며, 용량 제한도 없음
- Elasticsearch는 ILM 설정 없이 무한히 인덱스를 생성함

### 2. **불필요한 데이터 과다 수집**
- 디버깅용 `DEBUG` 로그가 너무 많았고
- 테스트용 서비스에서도 모든 메트릭과 로그를 수집하고 있었음

### 3. **고카디널리티 라벨 사용**
- Prometheus 라벨에 UUID, 세션ID 등 동적 값 사용 → 시계열 폭증

### 4. **정리 작업을 하지 않음**
- `docker system prune` 한 번도 안 함
- 테스트니까 괜찮겠지 하고 방치했더니 며칠 만에 수백 GB 사용

---

## ✅ 해결 방법 (적용 완료)

### 1. **보관 주기 & 용량 제한 설정**

- Prometheus:
  ```bash
  --storage.tsdb.retention.time=2d
  --storage.tsdb.retention.size=2GB
  ```
- Elasticsearch:
  - ILM 정책 설정: 2일 후 삭제, 2GB 이상 삭제

---

### 2. **수집 대상 최소화**

- 로그 레벨: `INFO` 또는 `WARN`으로 제한
- 불필요한 Exporter 제거
- Prometheus 라벨 고정화 → `job`, `instance`, `env` 등만 사용

---

### 3. **자동 정리 스크립트화**

- `scripts/docker-cleanup.sh` 작성  
- 주기적으로 실행되도록 `cron` 등록 또는 CI/CD 파이프라인에 삽입

---

### 4. **디스크 모니터링 및 알림 설정**

- Grafana 디스크 사용률 대시보드 구성  
- 80% 이상 사용 시 Slack 알림 전송  
- `df -h`, `docker system df`로 수시 확인

---

## 🧠 배운 점

- **"개발 환경이라도 운영처럼 다뤄야 한다."**  
- 기본 설정을 그대로 두면 생각보다 빠르게 디스크가 폭발한다  
- 모니터링 툴도 결국은 **자원 소비자**다. 관리하지 않으면 병목의 주범이 된다  
- **라벨 관리와 자동화 정리는 생존을 위한 필수 작업**

---

## 📝 Takeaway

> “관측 도구도 컨테이너도 용량은 기다려주지 않는다.  
> 개발 중이라도 운영처럼 관리하자.”